<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinity Wallet ♾️ - Non-Custodial Crypto Wallet</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>♾️</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBtbgeSVEwHGs50sHRe9GBle4xonalhIL0",
            authDomain: "anontalk-pfvvb.firebaseapp.com",
            projectId: "anontalk-pfvvb",
            storageBucket: "anontalk-pfvvb.firebasestorage.app",
            messagingSenderId: "600500129969",
            appId: "1:600500129969:web:f19c1c0b3603a44a00d290"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        window.auth = auth;
        window.signInWithGoogle = async () => {
            try {
                await signInWithPopup(auth, googleProvider);
            } catch (error) {
                alert('Error: ' + error.message);
            }
        };

        window.emailSignup = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert('Signup Error: ' + error.message);
            }
        };

        window.emailLogin = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert('Login Error: ' + error.message);
            }
        };

        window.logout = () => signOut(auth);
    </script>

    <!-- bip39 and ethers -->
    <script src="https://cdn.jsdelivr.net/npm/bip39@3.0.4/dist/bip39.min.js"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>

    <!-- QR Code for receive -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/dist/qrcode.min.js"></script>

    <script>
        // Web Crypto Helpers
        async function deriveKey(passphrase, salt) {
            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey('raw', encoder.encode(passphrase), 'PBKDF2', false, ['deriveBits', 'deriveKey']);
            return crypto.subtle.deriveKey({ name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' }, keyMaterial, { name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']);
        }

        async function encrypt(text, passphrase) {
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const key = await deriveKey(passphrase, salt);
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, new TextEncoder().encode(text));
            return btoa(String.fromCharCode(...salt)) + '.' + btoa(String.fromCharCode(...iv)) + '.' + btoa(String.fromCharCode(...new Uint8Array(encrypted)));
        }

        async function decrypt(encryptedData, passphrase) {
            const [saltB64, ivB64, dataB64] = encryptedData.split('.');
            const salt = new Uint8Array(atob(saltB64).split('').map(c => c.charCodeAt(0)));
            const iv = new Uint8Array(atob(ivB64).split('').map(c => c.charCodeAt(0)));
            const data = new Uint8Array(atob(dataB64).split('').map(c => c.charCodeAt(0)));
            const key = await deriveKey(passphrase, salt);
            const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, data);
            return new TextDecoder().decode(decrypted);
        }

        // Wallet Logic
        const RPC_URL = 'https://bsc-dataseed.binance.org/'; // BSC for EVM
        let currentWallet = null;
        let provider = new ethers.providers.JsonRpcProvider(RPC_URL);
        let timer;

        async function createWallet(passphrase) {
            const entropy = crypto.getRandomValues(new Uint8Array(16));
            const mnemonic = bip39.entropyToMnemonic(entropy);
            document.getElementById('mnemonic-phrase').textContent = mnemonic;
            document.getElementById('mnemonic-modal').style.display = 'block';

            // Wait for confirmation
            return new Promise((resolve) => {
                document.getElementById('confirm-mnemonic').onclick = async () => {
                    const userInput = document.getElementById('confirm-input').value.trim();
                    if (userInput !== mnemonic) {
                        alert('Mnemonic confirmation failed!');
                        return;
                    }
                    const wallet = ethers.Wallet.fromMnemonic(mnemonic);
                    const encryptedMnemonic = await encrypt(mnemonic, passphrase);
                    localStorage.setItem(`wallet_${auth.currentUser.uid}`, JSON.stringify({ encryptedMnemonic, address: wallet.address }));
                    loadWallet(wallet);
                    resolve();
                };
            });
        }

        async function importWallet(mnemonic, passphrase) {
            if (!bip39.validateMnemonic(mnemonic)) {
                alert('Invalid mnemonic!');
                return;
            }
            const wallet = ethers.Wallet.fromMnemonic(mnemonic);
            const encryptedMnemonic = await encrypt(mnemonic, passphrase);
            localStorage.setItem(`wallet_${auth.currentUser.uid}`, JSON.stringify({ encryptedMnemonic, address: wallet.address }));
            loadWallet(wallet);
        }

        async function unlockWallet(passphrase) {
            const stored = JSON.parse(localStorage.getItem(`wallet_${auth.currentUser.uid}`));
            if (!stored) {
                alert('No wallet found. Create or import one.');
                return;
            }
            try {
                const mnemonic = await decrypt(stored.encryptedMnemonic, passphrase);
                const wallet = ethers.Wallet.fromMnemonic(mnemonic);
                loadWallet(wallet);
            } catch {
                alert('Wrong passphrase!');
            }
        }

        function loadWallet(wallet) {
            currentWallet = wallet.connect(provider);
            document.getElementById('address').textContent = wallet.address;
            fetchBalance();
            fetchHistory();
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('wallet-section').style.display = 'block';
            startAutoLock();
        }

        async function fetchBalance() {
            const balance = await provider.getBalance(currentWallet.address);
            document.getElementById('balance').textContent = ethers.utils.formatEther(balance);
        }

        async function fetchHistory() {
            const history = await provider.getTransactionCount(currentWallet.address); // Simple count for demo; use Alchemy for full history
            document.getElementById('history').textContent = `Transactions: ${history}`;
        }

        async function sendTx() {
            const to = document.getElementById('send-to').value;
            const amount = document.getElementById('send-amount').value;
            const tx = {
                to,
                value: ethers.utils.parseEther(amount)
            };
            const signedTx = await currentWallet.signTransaction(tx);
            const response = await provider.sendTransaction(signedTx);
            alert(`Tx sent: ${response.hash}`);
            fetchBalance();
        }

        function showReceive() {
            const qr = document.getElementById('qr-code');
            qr.innerHTML = '';
            QRCode.toCanvas(qr, currentWallet.address, { width: 200 });
        }

        function startAutoLock() {
            clearTimeout(timer);
            timer = setTimeout(() => {
                currentWallet = null;
                alert('Wallet auto-locked due to inactivity.');
                showAuth();
            }, 300000); // 5 min
        }

        function showAuth() {
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('wallet-section').style.display = 'none';
        }

        // Live Prices
        async function fetchPrices() {
            const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum,binancecoin&vs_currencies=usd');
            const data = await res.json();
            document.getElementById('prices').innerHTML = `
                ETH: \[ {data.ethereum.usd}<br>
                BNB: \]{data.binancecoin.usd}
            `;
        }

        // Auth Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('user-email').textContent = user.email;
                const stored = localStorage.getItem(`wallet_${user.uid}`);
                if (stored) {
                    document.getElementById('unlock-section').style.display = 'block';
                } else {
                    document.getElementById('create-import-section').style.display = 'block';
                }
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'block';
                fetchPrices();
            } else {
                showAuth();
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('logout-btn').style.display = 'none';
            }
        });

        // Event Listeners
        document.addEventListener('mousemove', startAutoLock);
        document.addEventListener('keydown', startAutoLock);
    </script>

    <style>
        /* Black and White Theme */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: auto;
        }

        button {
            background-color: #333;
            color: #fff;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }

        input {
            padding: 10px;
            margin: 5px;
            background-color: #222;
            color: #fff;
            border: 1px solid #444;
        }
          .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #111;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        #wallet-section, #create-import-section, #unlock-section {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Infinity Wallet ♾️</h1>
        <div id="auth-section">
            <div id="login-form">
                <input id="email" type="email" placeholder="Email" />
                <input id="password" type="password" placeholder="Password" />
                <button onclick="emailSignup()">Sign Up</button>
                <button onclick="emailLogin()">Log In</button>
                <button onclick="signInWithGoogle()">Google Sign In</button>
            </div>
            <button id="logout-btn" onclick="logout()" style="display:none;">Log Out</button>
            <p id="user-email"></p>
        </div>

        <div id="create-import-section">
            <h2>Create or Import Wallet</h2>
            <button onclick="document.getElementById('create-modal').style.display='block'">Create New Wallet</button>
            <button onclick="document.getElementById('import-modal').style.display='block'">Import Wallet</button>
        </div>

        <div id="unlock-section">
            <h2>Unlock Wallet</h2>
            <input id="unlock-pass" type="password" placeholder="Passphrase" />
            <button onclick="unlockWallet(document.getElementById('unlock-pass').value)">Unlock</button>
        </div>

        <div id="wallet-section">
            <h2>Dashboard</h2>
            <p>Address: <span id="address"></span></p>
            <p>Balance: <span id="balance"></span> BNB</p>
            <p>History: <span id="history"></span></p>
            <div>
                <h3>Send</h3>
                <input id="send-to" placeholder="To Address" />
                <input id="send-amount" placeholder="Amount" />
                <button onclick="sendTx()">Send</button>
            </div>
            <div>
                <h3>Receive</h3>
                <button onclick="showReceive()">Show QR</button>
                <canvas id="qr-code"></canvas>
            </div>
            <div>
                <h3>Live Prices</h3>
                <div id="prices"></div>
            </div>
        </div>

        <!-- Modals -->
        <div id="mnemonic-modal" class="modal">
            <div class="modal-content">
                <h2>Your Recovery Phrase</h2>
                <p>Warning: Store securely. Lost phrase = lost funds!</p>
                <p id="mnemonic-phrase"></p>
                <input id="confirm-input" placeholder="Re-enter phrase to confirm" />
                <button id="confirm-mnemonic">Confirm</button>
            </div>
        </div>

        <div id="create-modal" class="modal">
            <div class="modal-content">
                <h2>Create Wallet</h2>
                <input id="create-pass" type="password" placeholder="Passphrase" />
                <button onclick="createWallet(document.getElementById('create-pass').value).then(() => this.parentNode.parentNode.style.display='none')">Create</button>
            </div>
        </div>

        <div id="import-modal" class="modal">
            <div class="modal-content">
                <h2>Import Wallet</h2>
                <input id="import-mnemonic" placeholder="12-word phrase" />
                <input id="import-pass" type="password" placeholder="Passphrase" />
                <button onclick="importWallet(document.getElementById('import-mnemonic').value, document.getElementById('import-pass').value).then(() => this.parentNode.parentNode.style.display='none')">Import</button>
            </div>
        </div>
    </div>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Simple Non-Custodial Wallet</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
  <style>
    :root { --bg: #04040d; --card: #0f0f1a; --muted: #a5a5c3; --accent: #7e57c2; --danger: #ff5252; --border: rgba(255,255,255,0.05); --input-bg: #1a1a2e; }
    body { margin: 0; background: var(--bg); color: #fff; font-family: Arial; padding: 20px; }
    .card { background: var(--card); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid var(--border); }
    input { width: 100%; padding: 10px; margin-bottom: 10px; background: var(--input-bg); border: 1px solid var(--border); color: #fff; border-radius: 5px; }
    button { padding: 10px; background: var(--accent); color: #fff; border: none; cursor: pointer; width: 100%; margin-bottom: 10px; border-radius: 5px; }
    .hidden { display: none; }
    .danger { color: var(--danger); }
    .mn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .mn-cell { background: var(--input-bg); padding: 10px; border-radius: 5px; text-align: center; border: 1px solid var(--border); }
  </style>
</head>
<body>
  <div id="auth">
    <div class="card">
      <h2>Signup / Login</h2>
      <input id="email" placeholder="Email (Gmail recommended)" type="email">
      <input id="password" placeholder="Password (min 6 chars)" type="password">
      <button id="btnSignUp">Signup</button>
      <button id="btnSignIn">Login</button>
    </div>
  </div>

  <div id="wallet" class="hidden">
    <div class="card">
      <h2>Wallet</h2>
      <button id="btnCreate">Create Wallet</button>
      <button id="btnImport">Import Wallet</button>
      <button id="btnUnlock" class="hidden">Unlock Local</button>
      <button id="btnSignOut">Sign Out</button>
      <div class="card" id="address">Address: -</div>
      <div id="balance">Balance: - ETH</div>
      <div id="qr" style="text-align: center; margin-top: 10px;"></div>
      <button id="btnExport" class="hidden">Export Phrase</button>
      <button id="btnDelete" class="hidden">Delete Local</button>
    </div>

    <div class="card">
      <h2>Send ETH</h2>
      <input id="to" placeholder="Recipient Address (0x...)">
      <input id="amount" placeholder="Amount (ETH)" type="number" step="0.0001">
      <button id="btnSend">Send</button>
    </div>
  </div>

  <div id="modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;">
    <div class="card" style="width:90%; max-width:600px;">
      <h2>Recovery Phrase</h2>
      <p class="danger">WARNING: Shown ONLY ONCE. Write down offline. Do not share or screenshot. Losing this loses your wallet.</p>
      <div id="phraseGrid" class="mn-grid"></div>
      <input id="confirm" placeholder="Type 'I SAVED' to confirm">
      <button id="btnConfirm">Confirm</button>
      <div id="saveSection" class="hidden">
        <input id="savePass" type="password" placeholder="Password (min 8 chars)">
        <button id="btnSaveLocal">Save Local</button>
        <button id="btnSkip">Skip</button>
      </div>
      <button id="btnCloseModal">Close</button>
    </div>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBtbgeSVEwHGs50sHRe9GBle4xonalhIL0",
      authDomain: "anontalk-pfvvb.firebaseapp.com",
      projectId: "anontalk-pfvvb",
      storageBucket: "anontalk-pfvvb.firebasestorage.app",
      messagingSenderId: "600500129969",
      appId: "1:600500129969:web:f19c1c0b3603a44a00d290"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // State
    let wallet, mnemonic;
    const rpc = 'https://rpc.ankr.com/eth_goerli'; // Testnet

    // Auth
    document.getElementById('btnSignUp').addEventListener('click', () => {
      firebase.auth().createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value)
        .then(() => showWallet())
        .catch(e => alert(e.message));
    });
    document.getElementById('btnSignIn').addEventListener('click', () => {
      firebase.auth().signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value)
        .then(() => showWallet())
        .catch(e => alert(e.message));
    });
    document.getElementById('btnSignOut').addEventListener('click', () => {
      firebase.auth().signOut().then(() => location.reload());
    });
    firebase.auth().onAuthStateChanged(user => {
      if (user) showWallet();
      else {
        document.getElementById('auth').classList.remove('hidden');
        document.getElementById('wallet').classList.add('hidden');
      }
    });

    function showWallet() {
      document.getElementById('auth').classList.add('hidden');
      document.getElementById('wallet').classList.remove('hidden');
      const local = localStorage.getItem('wallet_enc');
      if (local) document.getElementById('btnUnlock').classList.remove('hidden');
      if (wallet) updateUI();
    }

    // Wallet Functions
    document.getElementById('btnCreate').addEventListener('click', () => {
      wallet = new ethers.Wallet(ethers.utils.randomBytes(32));
      mnemonic = ethers.utils.entropyToMnemonic(ethers.utils.randomBytes(16));
      console.log('Phrase generated:', mnemonic); // Debug - check console (F12)
      showModal(mnemonic);
      updateUI();
      alert('Wallet created');
    });
    document.getElementById('btnImport').addEventListener('click', () => {
      const phrase = prompt('Enter 12-word phrase');
      if (!phrase) return;
      try {
        mnemonic = phrase;
        wallet = ethers.Wallet.fromMnemonic(phrase);
        updateUI();
        alert('Imported');
      } catch (e) { alert('Invalid phrase: ' + e.message); }
    });
    document.getElementById('btnUnlock').addEventListener('click', () => {
      const pwd = prompt('Enter password');
      if (!pwd) return;
      try {
        const enc = JSON.parse(localStorage.getItem('wallet_enc'));
        decrypt(pwd, enc).then(phrase => {
          mnemonic = phrase;
          wallet = ethers.Wallet.fromMnemonic(phrase);
          updateUI();
          alert('Unlocked');
        }).catch(e => alert('Wrong password: ' + e.message));
      } catch (e) { alert('Error: ' + e.message); }
    });
    document.getElementById('btnExport').addEventListener('click', () => {
      showModal(mnemonic);
    });
    document.getElementById('btnDelete').addEventListener('click', () => {
      if (confirm('Delete local?')) {
        localStorage.removeItem('wallet_enc');
        alert('Deleted');
        location.reload();
      }
    });

    // Modal
    function showModal(phrase) {
      const grid = document.getElementById('phraseGrid');
      grid.innerHTML = '';
      if (!phrase) return alert('Phrase error');
      phrase.split(' ').forEach((w, i) => {
        const div = document.createElement('div');
        div.className = 'mn-cell';
        div.textContent = `${i+1}. ${w}`;
        grid.appendChild(div);
      });
      document.getElementById('modal').classList.remove('hidden');
    }
    document.getElementById('btnConfirm').addEventListener('click', () => {
      if (document.getElementById('confirm').value !== 'I SAVED') return alert('Type I SAVED');
      document.getElementById('saveSection').classList.remove('hidden');
    });
    document.getElementById('btnSaveLocal').addEventListener('click', () => {
      const pwd = document.getElementById('savePass').value;
      if (pwd.length < 8) return alert('Min 8 chars');
      encrypt(pwd, mnemonic).then(enc => {
        localStorage.setItem('wallet_enc', JSON.stringify(enc));
        document.getElementById('modal').classList.add('hidden');
        document.getElementById('btnUnlock').classList.remove('hidden');
        document.getElementById('btnDelete').classList.remove('hidden');
        alert('Saved locally');
      }).catch(e => alert('Error: ' + e.message));
    });
    document.getElementById('btnSkip').addEventListener('click', () => document.getElementById('modal').classList.add('hidden'));
    document.getElementById('btnCloseModal').addEventListener('click', () => document.getElementById('modal').classList.add('hidden'));

    // Update UI
    async function updateUI() {
      document.getElementById('address').textContent = 'Address: ' + wallet.address;
      document.getElementById('qr').innerHTML = '';
      new QRCode(document.getElementById('qr'), wallet.address);
      document.getElementById('btnExport').classList.remove('hidden');
      const provider = new ethers.providers.JsonRpcProvider(rpc);
      const bal = await provider.getBalance(wallet.address);
      document.getElementById('balance').textContent = 'Balance: ' + ethers.utils.formatEther(bal) + ' ETH';
    }

    // Send
    document.getElementById('btnSend').addEventListener('click', async () => {
      const to = document.getElementById('to').value;
      const amt = document.getElementById('amount').value;
      if (!to || !amt) return alert('Fill fields');
      try {
        const provider = new ethers.providers.JsonRpcProvider(rpc);
        const signer = wallet.connect(provider);
        const tx = await signer.sendTransaction({ to, value: ethers.utils.parseEther(amt) });
        alert('TX sent: ' + tx.hash);
        updateUI();
      } catch (e) { alert('Send error: ' + e.message); }
    });

    // Encryption
    async function encrypt(password, text) {
      const salt = window.crypto.getRandomValues(new Uint8Array(16));
      const iv = window.crypto.getRandomValues(new Uint8Array(12));
      const key = await deriveKey(password, bytesToHex(salt));
      const ct = await window.crypto.subtle.encrypt({name: 'AES-GCM', iv}, key, new TextEncoder().encode(text));
      return { salt: bytesToHex(salt), iv: bytesToHex(iv), cipher: bytesToHex(ct) };
    }
    async function decrypt(password, obj) {
      const key = await deriveKey(password, obj.salt);
      const pt = await window.crypto.subtle.decrypt({name: 'AES-GCM', iv: hexToBytes(obj.iv)}, key, hexToBytes(obj.cipher));
      return new TextDecoder().decode(pt);
    }
    async function deriveKey(password, saltHex) {
      const enc = new TextEncoder();
      const passKey = await window.crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
      return await window.crypto.subtle.deriveKey({name: 'PBKDF2', salt: hexToBytes(saltHex), iterations: 100000, hash: 'SHA-256'}, passKey, {name: 'AES-GCM', length: 256}, false, ['encrypt', 'decrypt']);
    }
    function hexToBytes(hex) { const bytes = new Uint8Array(hex.length / 2); for (let i = 0; i < bytes.length; i++) bytes[i] = parseInt(hex.substr(i * 2, 2), 16); return bytes; }
    function bytesToHex(bytes) { return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(''); }
  </script>
</body>
</html>
